<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نافذة فاتي — هدية خالد</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    :root{
      --teal:#1a535c;           
      --gold:#ffcb69;           
      --fassi:#002e5d;          
      --rose:#c06c84;           
      --sand:#e8c39e;           
      --ink:#0f1c2b;            
      --deep-purple:#4b0082;    
      --light:#fffaf3;
      --text:#eaeaea;
      --blur:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:'Tajawal',sans-serif;
      color:var(--text);
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      background: radial-gradient(1200px 600px at 80% 10%, rgba(255,203,105,.18), transparent 55%),
                  linear-gradient(135deg, var(--ink) 0%, var(--fassi) 100%);
      perspective:1000px;
      overflow: hidden; /* تأكد من إخفاء شريط التمرير */
    }

    .bg-layer{
      position:fixed;inset:0;z-index:0;pointer-events:none;
      background:linear-gradient(135deg, var(--fassi), var(--teal));
      opacity:.18;mix-blend-mode:screen;
      transition:opacity .8s ease, filter 1.2s ease, background 1s ease;
      filter:saturate(1.05) contrast(1.05);
    }
    #particles-js{
      position:fixed;inset:0;z-index:1;background:transparent;opacity:.9;
    }
    
    /* شاشة الترحيب (Overlay) الجديدة */
    #start-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999; /* أعلى من كل شيء */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 50% 50%, rgba(15, 28, 43, 0.95), rgba(0, 46, 93, 0.98));
        opacity: 1;
        transition: opacity 1.2s ease-out, visibility 1.2s ease-out;
        visibility: visible;
        text-align: center;
        backdrop-filter: blur(2px);
    }
    #start-overlay.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
    }
    #start-overlay h2 {
        font-size: 44px;
        color: var(--gold);
        margin-bottom: 10px;
        text-shadow: 0 0 15px rgba(255,203,105,.8);
        font-weight: 800;
        animation: pulse 2s infinite;
    }
    #start-overlay p {
        font-size: 18px;
        color: var(--light);
        opacity: 0.8;
        margin-bottom: 40px;
    }
    /* زر شاشة الترحيب له تنسيق خاص لتمييزه */
    #startBtn {
        font-size: 20px;
        padding: 16px 36px;
        animation: sparkButton 1.5s ease-in-out infinite alternate;
        box-shadow: 0 0 20px rgba(255,203,105,.8), 0 0 40px rgba(255,160,117,.5);
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    @keyframes sparkButton {
        0% { transform: scale(1); box-shadow: 0 0 15px rgba(255,203,105,.8), 0 0 30px rgba(255,160,117,.5); }
        100% { transform: scale(1.02); box-shadow: 0 0 25px rgba(255,203,105,1), 0 0 50px rgba(255,160,117,.8); }
    }


    /* نافذة زجاجية عائمة */
    .window{
      position:relative;z-index:10;
      width:min(750px,92vw);
      padding:42px; 
      border-radius:32px;
      background:rgba(255,255,255,.09);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter:blur(var(--blur));
      box-shadow:0 28px 60px rgba(0,0,0,.45);
      transform-style:preserve-3d;
      animation:floatIn 1.1s ease-out, floating 7.5s ease-in-out infinite;
      text-align:center;
    }
    @keyframes floatIn{from{opacity:0;transform:translateY(54px) rotateX(8deg) rotateY(-5deg)}to{opacity:1;transform:translateY(0) rotateX(0) rotateY(0)}}
    @keyframes floating{0%,100%{transform:translateY(0) rotateZ(0.5deg)}50%{transform:translateY(-10px) rotateZ(-0.5deg)}}

    h1{
      margin:0 0 6px;font-size:38px;font-weight:800;color:var(--gold);
      letter-spacing:.5px;text-shadow:0 0 18px rgba(255,203,105,.55);
    }
    .subtitle{
      margin:0 0 28px;color:var(--light);opacity:.8;font-weight:500;letter-spacing:.6px;
    }
    #message{
      min-height:140px;font-size:22px;line-height:2;color:var(--light);
      transition:color .6s ease,text-shadow .6s ease, transform .6s ease;
    }
    #message.glow{
      text-shadow:0 0 16px rgba(255,203,105,.85), 0 0 4px rgba(255,255,255,.25);
      transform:translateZ(10px);
    }

    /* أزرار وتوقيع وشرارات */
    .actions{margin-top:26px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}
    button{
      padding:14px 26px;border:none;border-radius:50px;cursor:pointer;font-weight:800;
      background:linear-gradient(90deg,#ff9f75,var(--gold));
      color:#1a1a1a;letter-spacing:.4px;
      box-shadow:0 6px 14px rgba(0,0,0,.3);
      transition:transform .25s ease, box-shadow .25s ease, opacity .5s ease;
    }
    button.secondary{background:linear-gradient(90deg, var(--rose), var(--sand));color:#181818;}
    .signature{
      margin-top:20px;font-size:16px; 
      color:var(--gold);font-weight:800;opacity:.85;
      letter-spacing:.8px;text-shadow:0 0 10px rgba(255,203,105,.45);
    }
    footer{margin-top:32px;font-size:14px;color:var(--light);opacity:.6;}
    
    /* نص "فاتي ملكة الملكات" في الخلفية */
    .queen-text{
        position:absolute;z-index:5;
        font-family:'Tajawal',sans-serif;
        font-size:min(18vw, 150px); 
        font-weight:900;
        color:rgba(255,255,255,0);
        text-shadow:0 0 15px rgba(255,203,105,.3);
        letter-spacing:4px;
        pointer-events:none;
        transition:color 2.5s ease-out, text-shadow 2.5s ease-out, opacity 1s ease-out; 
        transform:translate(-50%, -50%) rotate(-5deg);
        white-space:nowrap;
        opacity:0;
        top:50%; left:50%; 
    }
    .queen-text.show{
        opacity:1; 
        color:rgba(255,255,255,.07); 
        text-shadow:0 0 25px rgba(255,203,105,.65), 0 0 5px rgba(255,255,255,.3);
        animation: queenFloating 20s ease-in-out infinite alternate; 
    }

    @keyframes queenFloating {
        0% { transform: translate(-52%, -48%) rotate(-6deg) scale(0.98); }
        100% { transform: translate(-48%, -52%) rotate(6deg) scale(1.02); }
    }

    /* تحسينات خاصة بالهاتف المحمول (Mobile Optimization) */
    @media (max-width: 768px) {
        .window {
            padding: 24px; 
            border-radius: 20px; 
        }
        h1 { font-size: 28px; }
        .subtitle { font-size: 14px; margin: 0 0 20px; }
        #message { font-size: 18px; line-height: 1.8; min-height: 100px; }
        .actions { margin-top: 20px; }
        button { padding: 12px 20px; font-size: 14px; }
        .queen-text {
            font-size: 14vw; 
            letter-spacing: 2px;
        }
        #start-overlay h2 { font-size: 32px; }
        #start-overlay p { font-size: 16px; margin-bottom: 30px; }
        #startBtn { font-size: 16px; padding: 14px 28px; }
    }
    
    /* ثيمات الألوان */
    .theme-0{background:radial-gradient(circle at 20% 30%, rgba(255,203,105,.25), transparent 40%), linear-gradient(120deg, var(--fassi), var(--teal))}
    .theme-1{background:radial-gradient(circle at 70% 20%, rgba(192,108,132,.24), transparent 45%), linear-gradient(120deg,#361b34,#6b2e4d)}
    .theme-2{background:radial-gradient(circle at 15% 80%, rgba(232,195,158,.28), transparent 45%), linear-gradient(120deg,#3a2f24,#7d5a37)}
    .theme-3{background:radial-gradient(circle at 85% 70%, rgba(140,205,197,.24), transparent 45%), linear-gradient(120deg,#0f1c2b,#1a535c)}
    .theme-4{background:radial-gradient(circle at 50% 50%, rgba(255,160,200,.3), transparent 60%), linear-gradient(120deg, var(--deep-purple), var(--rose))}

    /* تنسيق الشرارات (Sparks) المفقودة */
    .spark {
        position: fixed;
        width: 6px;
        height: 6px;
        background: var(--gold);
        border-radius: 50%;
        pointer-events: none;
        z-index: 20;
        opacity: 0;
        transform: translateZ(20px) scale(0);
        animation: sparkMove 1.5s ease-out forwards;
        box-shadow: 0 0 8px var(--gold);
    }
    @keyframes sparkMove {
        0% { opacity: 1; transform: translateZ(20px) scale(1); }
        100% { opacity: 0; transform: translate(var(--dx), var(--dy)) translateZ(20px) scale(0.2); }
    }
  </style>
</head>
<body>
  
  <div id="start-overlay">
    <h2>أهلاً بكِ في نافذتكِ المضيئة يا فاتي ✨</h2>
    <p>انقري على الزر لتبدأ رحلة اللؤلؤة وتكتمل التجربة السمعية والبصرية.</p>
    <button id="startBtn">ابدأ الرحلة الآن</button>
  </div>


  <div class="bg-layer theme-0" id="bg"></div>
  <div id="particles-js"></div>

<div class="queen-text" id="queenText">فاتي ملكة الملكات</div>

  <div class="window">
    <h1>نافذة فاتي المضيئة</h1>
    <p class="subtitle">— هدية راقية من خالد، لؤلؤة تشهد على جمال التفاصيل وتبقى في الذاكرة</p>

    <p id="message"></p>
    <div class="progress"><div class="bar" id="bar"></div></div>

    <div class="actions">
      <button id="nextBtn">إلى اللؤلؤة التالية</button>
      <button class="secondary" id="replayBtn">إعادة اللؤلؤة</button>
    </div>

    <div class="signature">— من خالد إلى فاتي، لتبقيكِ متلألئة في الذاكرة</div>
    <footer>— مكان يُقدّر الذكاء والإشراق والجمال الأصيل</footer>
  </div>

  <div class="heart-3d" id="heart"></div>

  <audio id="singleTrack" loop><source src="https://www.dropbox.com/scl/fi/g7bn0z0j0v3tc5iedgscu/a1.mp3.mb3?rlkey=5ntvosotat11wuvj2il7boqsh&st=r3igktyk&dl=1" type="audio/mp3"></audio>


  <script>
    
    // إزالة onload="showInitialAlert()" من <body> وإزالة دالة showInitialAlert()
    
    /* JavaScript - رسائل ومسارات الموسيقى (لا تغيير) */
    particlesJS('particles-js',{
      particles:{
        number:{value:85,density:{enable:true,value_area:820}},
        color:{value:"#ffcb69"},
        shape:{type:"circle"},
        opacity:{value:.5},
        size:{value:3,random:true},
        line_linked:{enable:true,distance:150,color:"#1a535c",opacity:.4,width:1},
        move:{enable:true,speed:1.6,random:false,straight:false,out_mode:"out"}
      },
      interactivity:{
        detect_on:"canvas",
        events:{onhover:{enable:true,mode:"grab"},onclick:{enable:true,mode:"push"},resize:true},
        modes:{grab:{distance:140,line_linked:{opacity:1}},push:{particles_nb:4}}
      },
      retina_detect:true
    });

    const messages = [
      { text:"فاتي، أنتِ كالنور المنبعث من *زليج فاس* العتيق، كل تفصيل فيكِ يحمل عبق *المغرب* وجماله الأصيل. ذكاءكِ يلمع كالكواكب. ✨", theme:0, track:0 },
      { text:"كطالبة اقتصاد، أنتِ تفهمين قيمة الأصول النادرة. وأنتِ *أثمن أصولي*، معادلة صعبة لكنها الأجمل. شغفكِ للمستقبل يلهمني. 📈", theme:1, track:0 }, 
      { text:"أينما حللتِ، ينبض الدفء. إن قلبكِ حنون كطعم *الكسكس* الذي تعدّه اليد المغربية بحبّ، يجمع الأهل ويحكي قصصًا. 🍲", theme:2, track:0 }, 
      { text:"الحياة تجربة، وأنتِ الدرجة الأكثر إشراقًا فيها. تذكري أن القوة لا تكمن في الظروف، بل في مرونة قلبكِ وثبات عقلكِ. 🌹", theme:3, track:0 }, 
      { text:"*الخاتمة:* هذه النافذة لن تنغلق. ستبقى فاتحة على قناعة بأن بصمتكِ في هذا العالم فريدة ولا تُعوض. *مستقبلكِ يستحق هذا الإشراق وهذه العظمة.* 💡", theme:4, track:0 } 
    ];

    /* عناصر DOM */
    const messageEl = document.getElementById('message');
    const bgEl = document.getElementById('bg');
    const nextBtn = document.getElementById('nextBtn');
    const replayBtn = document.getElementById('replayBtn');
    const barEl = document.getElementById('bar');
    const heartEl = document.getElementById('heart');
    const queenTextEl = document.getElementById('queenText'); 
    
    // العناصر الجديدة
    const startOverlayEl = document.getElementById('start-overlay');
    const startBtnEl = document.getElementById('startBtn');

    // ✅ الآن يتم الإشارة إلى أغنية واحدة فقط
    const singleTrack = document.getElementById('singleTrack');
    const tracks = [
      singleTrack, 
      singleTrack, 
      singleTrack, 
      singleTrack, 
      singleTrack
    ];

    let idx = 0;
    let typingTimer = null;
    let audioCurrent = null;
    let hasInteracted = false; 

    /* جميع الدوال الخاصة بالحركة والتبديل */
    function typeMessage(text, onDone){
      clearTimeout(typingTimer);
      messageEl.classList.remove('glow');
      messageEl.textContent = '';
      barEl.style.width = '0%';
      const total = text.length;
      let i = 0;
      (function step(){
        if(i < total){
          messageEl.textContent += text.charAt(i);
          barEl.style.width = ((i/total)*100).toFixed(2) + '%';
          i++;
          typingTimer = setTimeout(step, 34);  
        }else{
          messageEl.classList.add('glow');
          burstSparks(); 
          onDone && onDone();
        }
      })();
    }

    function setTheme(themeIndex){
      bgEl.className = 'bg-layer theme-' + themeIndex;
      bgEl.style.opacity = .22;
      bgEl.style.filter = 'saturate(1.1) contrast(1.08) hue-rotate(' + (themeIndex*14) + 'deg)';
    }

    async function playTrack(trackIndex){
      if (!hasInteracted) return; 
      
      const audio = singleTrack; 
      if(audioCurrent && !audioCurrent.paused && audioCurrent !== audio){
        await fadeOut(audioCurrent, 800);
        audioCurrent.pause();
      }
      
      if(audio.paused){
          audio.volume = 0;
          try{
            await audio.play(); 
            audioCurrent = audio;
            fadeIn(audio, 1400);
          }catch(e){
            console.error("Audio playback error: Could not load the online file.", e);
             console.warn("⚠ فشل تشغيل الموسيقى من الإنترنت. يرجى التأكد من وجود اتصال شبكة قوية وأن رابط Dropbox لا يزال يعمل.");
          }
      } else {
        audioCurrent = audio;
      }
    }

    function fadeIn(audio, duration=1200){
      const steps = 12; const maxVolume = 0.6; 
      const step = maxVolume/steps; let v = audio.volume;
      const iv = setInterval(()=>{
        v += step; audio.volume = Math.min(maxVolume, v);
        if(v >= maxVolume) clearInterval(iv);
      }, duration/steps);
    }

    function fadeOut(audio, duration=800){
      return new Promise(resolve=>{
        const steps = 10; const step = audio.volume/steps; let v = audio.volume;
        const iv = setInterval(()=>{
          v -= step; audio.volume = Math.max(0, v);
          if(v <= 0){ clearInterval(iv); resolve(); }
        }, duration/steps);
      });
    }

    function burstSparks(){
      const rect = messageEl.getBoundingClientRect();
      const centerX = rect.left + rect.width/2;
      const centerY = rect.top + rect.height/2;
      Array.from({length:14}).forEach(()=>{
        const s = document.createElement('div');
        s.className = 'spark';
        const dx = (Math.random()*180 - 90) + 'px';
        const dy = (Math.random()*90 - 45) + 'px';
        s.style.setProperty('--dx', dx);
        s.style.setProperty('--dy', dy);
        s.style.left = (centerX + (Math.random()*40 - 20)) + 'px';
        s.style.top  = (centerY + (Math.random()*20 - 10)) + 'px';
        document.body.appendChild(s);
        s.addEventListener('animationend', ()=>s.remove());
      });
    }

    function maybeShowHeart(){
      if(idx === messages.length - 1){ 
        // افترض أن لديك تنسيق CSS لـ #heart.show
        // heartEl.classList.add('show');
        // setTimeout(()=> heartEl.classList.remove('show'), 8000);
      }
    }

    function toggleQueenText(show){
        if(show){
            queenTextEl.classList.add('show');
        } else {
            queenTextEl.classList.remove('show');
        }
    }
    
    function runScene(sceneIndex){
      // تأكد من أننا نستخدم الـ idx الصحيح
      if (sceneIndex < 0 || sceneIndex >= messages.length) sceneIndex = 0;

      const scene = messages[sceneIndex];
      const isLastScene = (sceneIndex === messages.length - 1);

      nextBtn.style.opacity = isLastScene ? '0' : '1';
      nextBtn.style.pointerEvents = isLastScene ? 'none' : 'auto';
      replayBtn.style.opacity = '0'; 
      replayBtn.style.pointerEvents = 'none';

      toggleQueenText(false); 

      setTheme(scene.theme);
      // تأكد أن playTrack يتم استدعاؤها بعد التفاعل الأول
      if (hasInteracted) playTrack(scene.track);
      
      typeMessage(scene.text, ()=>{
        if(!isLastScene) { 
             nextBtn.style.opacity = '1'; 
             nextBtn.style.pointerEvents = 'auto';
        } else {
             toggleQueenText(true); 
        }
        replayBtn.style.opacity = '1'; 
        replayBtn.style.pointerEvents = 'auto';
        maybeShowHeart();
      });
      
    }
    
    // الوظيفة الأساسية التي تبدأ كل شيء
    function handleFirstInteraction(){
      if(!hasInteracted){
        hasInteracted = true;
        // إخفاء شاشة الترحيب
        startOverlayEl.classList.add('hidden');
        // بدء أول رسالة (وهي التي ستبدأ الموسيقى عبر playTrack بداخلها)
        runScene(idx);
      }
    }


    /* ربط الدوال بالأزرار */
    document.addEventListener('DOMContentLoaded', ()=>{
        // تهيئة المشهد الأول (لكنه لن يبدأ الكتابة ولا الموسيقى)
        // runScene(0) لم يعد مطلوبًا هنا لأنه سيبدأ في handleFirstInteraction()
        
        // ربط زر "ابدأ الرحلة الآن" بوظيفة التفاعل الأول
        startBtnEl.addEventListener('click', handleFirstInteraction);
        
        nextBtn.addEventListener('click', ()=>{
          idx = (idx + 1) % messages.length;
          runScene(idx);
        });

        replayBtn.addEventListener('click', ()=>{
          // لا نغير idx هنا، فقط نعيد تشغيل المشهد الحالي
          runScene(idx);
        });

        // إخفاء أزرار التحكم في البداية
        nextBtn.style.opacity = '0';
        nextBtn.style.pointerEvents = 'none';
        replayBtn.style.opacity = '0';
        replayBtn.style.pointerEvents = 'none';
        
    });
  </script>
</body>
</html>
